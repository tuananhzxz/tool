{% extends "base.html" %}

{% block title %}{{ function_title }} - Image Processing Tools{% endblock %}

{% block content %}
<div class="container">
    <h2 class="mb-4">{{ function_title }}</h2>
    
        <div class="card">
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    {% if function_name == 'changeImage' %}
                    <div class="mb-3">
                    <label for="target_format" class="form-label">Chọn định dạng đích:</label>
                    <select class="form-select" id="target_format" name="target_format">
                            <option value="webp">WebP</option>
                            <option value="jpeg">JPEG</option>
                            <option value="png">PNG</option>
                        </select>
                    </div>
                {% endif %}

                {% if function_name == 'cutmergeimage' %}
                    <div class="mb-3">
                    <label for="action" class="form-label">Chọn hành động:</label>
                    <select class="form-select" id="action" name="action">
                            <option value="split">Cắt ảnh</option>
                            <option value="merge">Ghép ảnh</option>
                        </select>
                    </div>
                <div class="mb-3">
                    <label for="parts" class="form-label">Số phần:</label>
                    <input type="number" class="form-control" id="parts" name="parts" value="2" min="2">
                </div>
                <div class="mb-3">
                    <label for="width" class="form-label">Chiều rộng (để trống để giữ nguyên):</label>
                    <input type="number" class="form-control" id="width" name="width">
                </div>
                <div class="mb-3">
                    <label for="height" class="form-label">Chiều cao (để trống để giữ nguyên):</label>
                    <input type="number" class="form-control" id="height" name="height">
                </div>
                {% endif %}

                {% if function_name == 'dowloaf' %}
                <div class="mb-4">
                    <h5>Tải ảnh từ web</h5>
                    <form id="urlForm">
                        <div class="mb-3">
                            <label for="url" class="form-label">URL trang web:</label>
                            <input type="url" class="form-control" id="url" name="url" placeholder="Nhập URL trang web">
                        </div>
                        <div class="mb-3">
                            <label for="html_code" class="form-label">Hoặc nhập mã HTML:</label>
                            <textarea class="form-control" id="html_code" name="html_code" rows="5" placeholder="Dán mã HTML vào đây"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Tìm ảnh</button>
                    </form>

                    <div id="imagePreview" class="mt-4" style="display: none;">
                        <h6>Ảnh tìm thấy:</h6>
                        <div class="row" id="imageGrid">
                            <!-- Ảnh sẽ được thêm vào đây -->
                        </div>
                        <div class="mt-3">
                            <button id="downloadSelected" class="btn btn-success" disabled>Tải ảnh đã chọn</button>
                            <button id="selectAll" class="btn btn-secondary">Chọn tất cả</button>
                        </div>
                    </div>

                    <div id="resultArea" class="mt-4" style="display: none;">
                        <h6>Kết quả:</h6>
                        <p id="message" class="alert"></p>
                        <div id="downloadButtons">
                            <!-- Nút tải xuống sẽ được thêm vào đây -->
                        </div>
                    </div>
                </div>
                {% else %}
                    <div class="mb-3">
                    <label for="files" class="form-label">Chọn file:</label>
                    <input type="file" class="form-control" id="files" name="files" multiple required>
                </div>
                {% endif %}

                {% if function_name == 'ocr' %}
                <div class="mb-4">
                    <h5>Nhận dạng và dịch văn bản từ ảnh</h5>
                    <div class="alert alert-info">
                        <strong>Lưu ý:</strong> Để sử dụng tính năng dịch tự động, bạn cần cung cấp API key của Google Gemini.
                        <a href="https://makersuite.google.com/app/apikey" target="_blank">Nhận API key tại đây</a>
                    </div>
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="files" class="form-label">Chọn ảnh (có thể chọn nhiều ảnh)</label>
                            <input type="file" class="form-control" id="files" name="files" multiple accept="image/*" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="api_key" class="form-label">API Key Gemini (tùy chọn)</label>
                            <input type="text" class="form-control" id="api_key" name="api_key" placeholder="Nhập API key để sử dụng tính năng dịch">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Ngôn ngữ dịch (có thể chọn nhiều)</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="target_langs[]" value="vi" id="lang_vi" checked>
                                <label class="form-check-label" for="lang_vi">Tiếng Việt</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="target_langs[]" value="en" id="lang_en">
                                <label class="form-check-label" for="lang_en">Tiếng Anh</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="target_langs[]" value="ja" id="lang_ja">
                                <label class="form-check-label" for="lang_ja">Tiếng Nhật</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="target_langs[]" value="ko" id="lang_ko">
                                <label class="form-check-label" for="lang_ko">Tiếng Hàn</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="target_langs[]" value="zh" id="lang_zh">
                                <label class="form-check-label" for="lang_zh">Tiếng Trung</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="genre" class="form-label">Thể loại truyện (để tối ưu văn phong)</label>
                            <select class="form-select" id="genre" name="genre">
                                <option value="">Không xác định</option>
                                <option value="drama">Drama - Tình cảm</option>
                                <option value="adult">Người lớn</option>
                                <option value="romance">Ngôn tình</option>
                                <option value="comedy">Hài hước</option>
                                <option value="bl">Đam mỹ</option>
                                <option value="wuxia">Kiếm hiệp</option>
                                <option value="action">Hành động</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <button type="submit" class="btn btn-primary">Xử lý OCR</button>
                        </div>
                    </form>

                    <div id="resultSection" class="d-none">
                        <h6>Kết quả xử lý:</h6>
                        <div id="wordFiles" class="mb-3">
                            <!-- Danh sách file Word sẽ được thêm vào đây -->
                        </div>
                    <div class="mb-3">
                            <button id="downloadAll" class="btn btn-success">Tải tất cả</button>
                            <button id="mergeFiles" class="btn btn-info">Gộp file</button>
                        </div>
                    </div>
                    </div>
                    {% endif %}

                    <button type="submit" class="btn btn-primary">Xử lý</button>
                </form>

            <div id="resultArea" class="mt-4" style="display: none;">
                <h4>Kết quả:</h4>
                <p id="message" class="alert alert-success"></p>
                
                {% if function_name == 'ocr' %}
                <div id="wordFiles" class="list-group mb-3">
                    <!-- Danh sách các file Word sẽ được thêm vào đây -->
                </div>
                <button id="mergeButton" class="btn btn-success mb-3" style="display: none;">
                    Gộp tất cả file Word
                </button>
                {% endif %}
                
                <div id="downloadButtons">
                    <!-- Nút tải xuống sẽ được thêm vào đây -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitButton = this.querySelector('button[type="submit"]');
    const resultArea = document.getElementById('resultArea');
    const messageArea = document.getElementById('message');
    const downloadButtons = document.getElementById('downloadButtons');
    const wordFiles = document.getElementById('wordFiles');
    const mergeButton = document.getElementById('mergeButton');
    
    submitButton.disabled = true;
    submitButton.innerHTML = 'Đang xử lý...';
    resultArea.style.display = 'none';
    
    try {
        const response = await fetch('/execute/{{ function_name }}', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.error) {
            messageArea.className = 'alert alert-danger';
            messageArea.textContent = result.error;
        } else {
            messageArea.className = 'alert alert-success';
            messageArea.textContent = result.message;
            
            // Xóa các nút tải xuống cũ
            downloadButtons.innerHTML = '';
            
            {% if function_name == 'ocr' %}
            // Hiển thị danh sách file Word
            if (result.word_files) {
                wordFiles.innerHTML = '';
                result.word_files.forEach(file => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action';
                    item.textContent = file;
                    wordFiles.appendChild(item);
                });
                
                // Hiển thị nút gộp nếu có nhiều hơn 1 file
                if (result.word_files.length > 1) {
                    mergeButton.style.display = 'block';
                }
            }
            {% endif %}
            
            // Thêm các nút tải xuống mới
            result.output_files.forEach(file => {
                const btn = document.createElement('a');
                btn.href = `/download/${file}`;
                btn.className = 'btn btn-success me-2';
                btn.textContent = 'Tải xuống kết quả';
                downloadButtons.appendChild(btn);
            });
        }
        
        resultArea.style.display = 'block';
    } catch (error) {
        messageArea.className = 'alert alert-danger';
        messageArea.textContent = 'Có lỗi xảy ra khi xử lý yêu cầu';
        resultArea.style.display = 'block';
    }
    
    submitButton.disabled = false;
    submitButton.innerHTML = 'Xử lý';
});

{% if function_name == 'ocr' %}
// Xử lý sự kiện gộp file Word
document.getElementById('mergeButton').addEventListener('click', async function() {
    const formData = new FormData();
    const wordFiles = document.getElementById('wordFiles');
    const files = Array.from(document.getElementById('files').files);
    
    files.forEach(file => {
        formData.append('files', file);
    });
    
    try {
        const response = await fetch('/execute/merge_ocr', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.error) {
            alert(result.error);
        } else {
            // Thêm nút tải xuống file đã gộp
            const downloadButtons = document.getElementById('downloadButtons');
            downloadButtons.innerHTML = '';
            
            const btn = document.createElement('a');
            btn.href = `/download/${result.output_files[0]}`;
            btn.className = 'btn btn-success';
            btn.textContent = 'Tải xuống file đã gộp';
            downloadButtons.appendChild(btn);
        }
    } catch (error) {
        alert('Có lỗi xảy ra khi gộp file');
    }
});
{% endif %}

{% if function_name == 'dowloaf' %}
// Xử lý phản hồi từ API khi tải từ URL
document.getElementById('urlForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitButton = this.querySelector('button[type="submit"]');
    const imagePreview = document.getElementById('imagePreview');
    const imageGrid = document.getElementById('imageGrid');
    const downloadSelected = document.getElementById('downloadSelected');
    const selectAll = document.getElementById('selectAll');
    
    submitButton.disabled = true;
    submitButton.innerHTML = 'Đang tìm ảnh...';
    imagePreview.style.display = 'none';
    
    try {
        const response = await fetch('/execute/dowloaf', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.error) {
            alert(result.error);
        } else if (result.chapters) {
            // Hiển thị danh sách chapter
            const chapterList = document.createElement('div');
            chapterList.className = 'list-group mt-3';
            
            result.chapters.forEach(chapter => {
                const link = document.createElement('a');
                link.href = chapter.url;
                link.className = 'list-group-item list-group-item-action';
                link.textContent = chapter.title;
                link.target = '_blank';
                chapterList.appendChild(link);
            });
            
            imageGrid.innerHTML = '';
            imageGrid.appendChild(chapterList);
            imagePreview.style.display = 'block';
        } else if (result.images) {
            // Hiển thị lưới ảnh
            imageGrid.innerHTML = '';
            result.images.forEach((image, index) => {
                const col = document.createElement('div');
                col.className = 'col-md-3 mb-3';
                
                const card = document.createElement('div');
                card.className = 'card h-100';
                
                const img = document.createElement('img');
                img.src = image.preview;
                img.className = 'card-img-top';
                img.alt = image.alt;
                img.style.maxHeight = '200px';
                img.style.objectFit = 'cover';
                
                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'form-check-input';
                checkbox.dataset.url = image.url;
                checkbox.addEventListener('change', () => {
                    const checkedBoxes = document.querySelectorAll('#imageGrid input[type="checkbox"]:checked');
                    downloadSelected.disabled = checkedBoxes.length === 0;
                });
                
                cardBody.appendChild(checkbox);
                card.appendChild(img);
                card.appendChild(cardBody);
                col.appendChild(card);
                imageGrid.appendChild(col);
            });
            
            imagePreview.style.display = 'block';
            downloadSelected.disabled = true;
        }
    } catch (error) {
        alert('Có lỗi xảy ra khi tìm ảnh');
    }
    
    submitButton.disabled = false;
    submitButton.innerHTML = 'Tìm ảnh';
});

// Xử lý chọn tất cả ảnh
document.getElementById('selectAll').addEventListener('click', function() {
    const checkboxes = document.querySelectorAll('#imageGrid input[type="checkbox"]');
    const isAllChecked = Array.from(checkboxes).every(cb => cb.checked);
    
    checkboxes.forEach(cb => {
        cb.checked = !isAllChecked;
    });
    
    document.getElementById('downloadSelected').disabled = isAllChecked;
});

// Xử lý tải ảnh đã chọn
document.getElementById('downloadSelected').addEventListener('click', async function() {
    const checkboxes = document.querySelectorAll('#imageGrid input[type="checkbox"]:checked');
    const imageUrls = Array.from(checkboxes).map(cb => cb.dataset.url);
    
    if (imageUrls.length === 0) {
        alert('Vui lòng chọn ít nhất một ảnh');
        return;
    }
    
    try {
        const response = await fetch('/execute/download_images', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ image_urls: imageUrls })
        });
        
        const result = await response.json();
        
        if (result.error) {
            alert(result.error);
        } else {
            const resultArea = document.getElementById('resultArea');
            const message = document.getElementById('message');
            const downloadButtons = document.getElementById('downloadButtons');
            
            message.className = 'alert alert-success';
            message.textContent = result.message;
            
            downloadButtons.innerHTML = '';
            result.output_files.forEach(file => {
                const btn = document.createElement('a');
                btn.href = `/download/${file}`;
                btn.className = 'btn btn-success me-2';
                btn.textContent = 'Tải xuống kết quả';
                downloadButtons.appendChild(btn);
            });
            
            resultArea.style.display = 'block';
        }
    } catch (error) {
        alert('Có lỗi xảy ra khi tải ảnh');
    }
});
{% endif %}
</script>
{% endblock %} 